<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RAMP Streaming Test</title>
    <script type="text/javascript">
        var websocket = null;
        var context, audioStack = [];
        var nextTime = 0;

        function writeToScreen(message) {
            var pre = document.createElement("p");
            pre.style.wordWrap = "break-word";
            pre.innerHTML = message;
            document.getElementById("output").appendChild(pre);
        };

        function streamMusic() {
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext || window.MozWebSocket;
                context = new AudioContext();
            } catch(e) {
                writeToScreen("Web Audio API is not supported in this browser.");
            }

            // See if a local server is started.
            // var socketURL = "127.0.0.1:8080";
            var socketURL = "ramp-server.embercode.com";

            writeToScreen("Beginning socket connection.");
            websocket = new WebSocket("ws://" + socketURL + "/stream");
            websocket.binaryType = "arraybuffer";
            output = document.getElementById("output");

            websocket.onopen = function() {
                writeToScreen("Connected to the socket server.");
            };

            websocket.onclose = function() {
                writeToScreen("Disconnected from the socket server.");
            };

            // NOTE: You can apparently do typeof message.data == "string".
            websocket.onmessage = function(message) {
                // Convert the message data so that each value is between -1 and 1.
                var audio = [];
                var intArray = new Int16Array(message.data);
                for (var i = 0; i < intArray.length; i++) {
                    audio[i] = (intArray[i] > 0) ? intArray[i]/32767 : intArray[i]/32768;
                }

                // Create a new AudioBuffer.
                var source = context.createBufferSource();
                var buffer = context.createBuffer(1, audio.length, 44100);
                buffer.getChannelData(0).set(audio);

                // Schedule the AudioBuffer for playback.
                source.buffer = buffer;
                source.connect(context.destination);
                source.start(nextTime);
                nextTime += source.buffer.duration;
            };

            websocket.onerror = function(error) {
                writeToScreen('<span style="color: red;">ERROR:</span> ' + error);
            };
        }
    </script>
</head>
<body>
    <h2>RAMP Streaming Test</h2>
    <button id="send" onClick="javascript: streamMusic();">Stream Music</button>
    <!-- <button id="send" onClick="javascript: source.stop(0);">Stop</button> -->
    <div id="output"></div>
</body>
</html>
