<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="google" content="notranslate">
	<meta name="viewport" content="width=device-width, minimal-ui">
	<title>RAMP</title>

	<link rel="stylesheet" type="text/css" href="css/normalize.min.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">

	<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
	<script type="text/javascript" src="js/jsrender.min.js"></script>
	<script src="js/jquery.knob.min.js"></script>
</head>
<body>
	<header>
		<h1></h1>
	</header>

	<div id="content">
		<!-- Left Section: Track Controls -->
		<div id="track-controls" style="display:none">
			<div id="mixer-{{:num}}" class="mixer">
				<div class="v-align">
					<div class="equalizers">
						<div class="eq_low">
							<input class="knob" data-angleArc="300" data-angleOffset="-150" value="0" data-max="100" data-min="-100" data-width="35" data-height="35" data-thickness=".45" data-cursor="true" data-displayInput="false" data-bgColor="#555" data-fgColor="#3498db" data-track="{{:num}}">
							<label>L</label>
						</div>

						<div class="eq_med">
							<input class="knob" data-angleArc="300" data-angleOffset="-150" value="0" data-max="100" data-min="-100" data-width="35" data-height="35" data-thickness=".45" data-cursor="true" data-displayInput="false" data-bgColor="#555" data-fgColor="#3498db" data-track="{{:num}}">
							<label>M</label>
						</div>

						<div class="eq_high">
							<input class="knob" data-angleArc="300" data-angleOffset="-150" value="0" data-max="100" data-min="-100" data-width="35" data-height="35" data-thickness=".45" data-cursor="true" data-displayInput="false" data-bgColor="#555" data-fgColor="#3498db" data-track="{{:num}}">
							<label>H</label>
						</div>
					</div>

					<div class="volume-balance">
						<div class="balance">
							<label>L</label>
							<input type="range" min="0" max="10" value="5" data-track="{{:num}}" name="panning">
							<label>R</label>
						</div>

						<div class="volume">
							<img src="img/vol-min.png" alt="" width="11" height="18">
							<input type="range" min="-10" max="10" value="0" data-track="{{:num}}" name="volume">
							<img src="img/vol-max.png" alt="" width="24" height="18">
						</div>
					</div>

					<div class="mute-solo">
						<button class="mute-button" data-track="{{:num}}">M</button>
						<button class="solo-button" data-track="{{:num}}">S</button>
					</div>
				</div> <!-- .v-align -->

				<div class="track-name"><span>{{:name}}</span></div>
			</div> <!-- .mixer -->
		</div> <!-- #track-controls-->

		<!-- Right Section: Waveforms  -->
		<div id="track-waveforms" style="display:none">
			<div id="track-{{:num}}" class="track">
				<img src="{{:waveform_path}}" class="waveform {{:~waveformStyle(num)}}" alt="" width="{{:~waveformWidth(length)}}">
			</div>
		</div>
	</div> <!-- .content -->

	<footer>
		<div id="master-volume">
			<img src="img/vol-min.png" alt="" width="11" height="18">
			<input type="range" min="-10" max="10" value="0" id="master-volume-slider" name="master-volume-slider">
			<img src="img/vol-max.png" alt="" width="24" height="18">
		</div>

		<div id="master-play">
			<input type="image" src="img/play.png" alt="Play" data-status="paused" width="50" height="50">
		</div>

		<div id="master-scrubber" style="opacity:0">
			<label for="master-volume-slider">Scrubber:</label>
			<input type="range" min="0" max="100" value="10" id="master-volume-slider" name="master-volume-slider">
		</div>
	</footer>

	<script type="text/javascript">
		var websocket = null, context;
		var nextTime = 0;

		try {
			window.AudioContext = window.AudioContext || window.webkitAudioContext || window.MozWebSocket;
			context = new AudioContext();
		} catch(e) {
			// TODO: This needs to be displayed to the user somewhere.
			console.log("Web Audio API is not supported in this browser.");
		}

		var socketURL = "127.0.0.1:8080";
		// var socketURL = "ramp-server.embercode.com";

		function connectWebsocket() {
			// Connect to the websocket.
			console.log("Beginning socket connection.");
			websocket = new WebSocket("ws://" + socketURL + "/stream");
			websocket.binaryType = "arraybuffer";

			websocket.onopen = function() {
				console.log("Connected to the socket server.");

				// Prepare the server for streaming.
				websocket.send("/position 0.0f");
				websocket.send("/master/vol -0.98f");
			}

			websocket.onclose = function() {
				console.log("Disconnected from the socket server.");
			};

			// NOTE: You can apparently do typeof message.data == "string".
			websocket.onmessage = function(message) {
				var leftChannel = [], rightChannel = [];

				// Convert the message data so that each value is between -1 and 1.
				var intArray = new Int16Array(message.data);
				for (var i = 0; i < intArray.length; i++) {
					var val = (intArray[i] > 0) ? intArray[i]/32767 : intArray[i]/32768;

					// De-interleave the channels.
					if (i % 2 == 0) {
						leftChannel.push(val);
					} else {
						rightChannel.push(val);
					}
				}

				// Create a new AudioBuffer.
				var source = context.createBufferSource();
				var buffer = context.createBuffer(2, leftChannel.length, 48000);
				buffer.getChannelData(0).set(leftChannel);
				buffer.getChannelData(1).set(rightChannel);
				source.buffer = buffer;
				source.connect(context.destination);

				// Schedule the AudioBuffer for playback.
				source.start(nextTime);
				nextTime += buffer.duration;
			}
		}

		// If RAMP is being loaded from file://, fall back to the remote copy of
		// tracks.json. Chrome won't load the local copy due to security concerns.
		var trackURL;
		switch(window.location.protocol) {
			case 'http:':
			case 'https:':
				trackURL = "tracks.json";
				break;
			default:
				trackURL = "http://ramp.embercode.com/tracks.json"
				break;
		}

		// A list of the possible CSS styles for each waveform.
		var waveformStyles = [
			"wf-blue",
			"wf-green",
			"wf-yellow",
			"wf-orange",
			"wf-red",
			"wf-purple"
		];

		// Request the track information (in JSON format) from the webserver.
		// This will eventually get requested from the RAMP Server instead.
		$.getJSON(trackURL, function(trackList) {
			// Render the song title.
			var songTitle = $.templates("{{:title}}").render(trackList);
			$("h1").html(songTitle);
			document.title = "RAMP - " + songTitle;

			// Render the track controls.
			// NOTE: The #track-controls default to display:none so the page can
			//       fail gracefully if the track list fails to load.
			var controlsTemplate = $.templates($("#track-controls").html());
			$("#track-controls").html(
				controlsTemplate.render(trackList["tracks"])
			).css("display", "block");

			// Render the track waveforms.
			// NOTE: The #track-waveforms default to display:none so the page can
			//       fail gracefully if the track list fails to load.
			var waveformsTemplate = $.templates($("#track-waveforms").html());
			$("#track-waveforms").html(
				waveformsTemplate.render(trackList["tracks"], {
					waveformStyle:function(num) {
						// Assigns a different background color to each waveform.
						return waveformStyles[num % waveformStyles.length];
					},
					waveformWidth:function(length) {
						// Returns the image width: length (in seconds) * 30px
						return length * 30;
					}
				})
			).css("display", "block");

			// Render the knobs.
			$(".knob").knob({
				change : function (value) {
					//console.log("change : " + value);
				},
				release : function (value) {
					//console.log(this.$.attr('value'));
					console.log("release : " + value);
				},
				cancel : function () {
					console.log("cancel : ", this);
				},
				/*format : function (value) {
					return value + '%';
				},*/
				draw : function () {
					this.cursorExt = 0.25;

					var a = this.arc(this.cv)  // Arc
						 , pa                   // Previous arc
						 , r = 1;

					this.g.lineWidth = this.lineWidth;
				}
			});

			// Setup the mute buttons.
			$(".mute-button").click(function() {
				var elem = $(this);
				var num = elem.attr("data-track");

				// Alert the websocket, toggle the button styles, and toggle the waveform styles.
				if (elem.hasClass("enabled")) {
					websocket.send("/track" + num + "/mute 0");
					elem.removeClass("enabled");
					$("#track-" + num + " img").removeClass("isMuted");
				} else {
					websocket.send("/track" + num + "/mute 1");
					elem.addClass("enabled");
					$("#track-" + num + " img").addClass("isMuted");
				}
			});

			// Setup the solo buttons.
			$(".solo-button").click(function() {
				// Toggle the solo button.
				var elem = $(this);
				var num = elem.attr("data-track");

				// Alert the websocket, toggle the button styles, and toggle the waveform styles.
				if (elem.hasClass("enabled")) {
					websocket.send("/track" + num + "/solo 0");
					elem.removeClass("enabled");
					$("#track-" + num + " img").removeClass("isSolo");
				} else {
					websocket.send("/track" + num + "/solo 1");
					elem.addClass("enabled");
					$("#track-" + num + " img").addClass("isSolo");
				}

				// If there are no more soloed tracks, re-enable everything.
				if ( $(".isSolo").length === 0 ) {
					$(".waveform").each(function() {
						$(this).removeClass("notSolo");
					})
				}

				// Otherwise, visually disable all other tracks.
				else {
					$(".waveform").each(function() {
						var wf = $(this);
						if ( !wf.hasClass("isSolo") ) {
							wf.addClass("notSolo");
						} else {
							wf.removeClass("notSolo");
						}
					})
				}
			}) // $(".solo-button")

			// Setup the left-right pan sliders.
			$(".balance input").change(function() {
				var elem = $(this);
				var num = elem.attr("data-track");
				var val = elem.val();

				websocket.send("/track" + num + "/pan " + val/10.0);
			});

			// Setup the individual volume sliders.
			$(".volume input").change(function() {
				var elem = $(this);
				var num = elem.attr("data-track");
				var val = elem.val();

				websocket.send("/track" + num + "/vol " + val/10.0);
			});

			// Setup the master volume sliders.
			$("#master-volume input").change(function() {
				var elem = $(this);
				var num = elem.attr("data-track");
				var val = elem.val();

				// websocket.send("/master/vol " + val/10.0);
				websocket.send("/master/vol " + (-0.98 + val/10.0/50.0) );
			});

			// If there are any pre-muted tracks (in tracks.json), mute them.
			// This can be expanded to perform other saved EQ operations in the future.
			var tracks = trackList["tracks"];
			tracks.forEach(function(track) {
				if (track.muted) {
					$(".mute-button[data-track=" + track.num + "]").click();
				}
			});

		}); // $.getJSON()

		// Don't let the controls scoll vertically.
		$(window).scroll(function() {
			// We calculate this every scroll incase the user has resized the window.
			var maxHeight = $(document).height() - $(window).height();
			var scrollTop = $(document).scrollTop() || $("html, body").scrollTop();

			// Don't let the controls scoll vertically.
			// NOTE: If scrollTop is greater than maxHeight the user has scrolled
			// past the end of the page, which is why we don't move the controls.
			if (scrollTop <= maxHeight) {
				$("#track-controls").css("margin-top", "-" + scrollTop + "px");
			}
		});

		// Toggle the play/pause button when clicked.
		// NOTE: The image displays what will happen not what is happening.
		$("#master-play input").click(function() {
			var elem = $(this);

			// Swapping from Play to Pause.
			if (elem.attr("data-status") == "playing") {
				elem.attr("src", "img/play.png");
				elem.attr("data-status", "paused");

				websocket.send("/pause");
			}

			// Swapping from Pause to Play.
			else {
				elem.attr("src", "img/pause.png");
				elem.attr("data-status", "playing");

				websocket.send("/play");
			}
		});

		connectWebsocket();
	</script>
</body>
</html>
